# Cogent Agent - Docker Compose Configuration
# Includes NATS server with JetStream and the AI Agent container

services:
  # ==========================================================================
  # NATS Server with JetStream
  # ==========================================================================
  nats:
    image: nats:2.10-alpine
    container_name: cogent-nats
    command:
      - "--config=/etc/nats/nats.conf"
    ports:
      - "4223:4222"   # Client connections (4223 to avoid conflict)
      - "8223:8222"   # HTTP monitoring (8223 to avoid conflict)
      - "6223:6222"   # Cluster routing (for future scaling)
      - "9223:9222"   # WebSocket connections
    volumes:
      - nats_data:/data
      - ./config/nats.conf:/etc/nats/nats.conf:ro
    networks:
      - cogent-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # ==========================================================================
  # Cogent Agent
  # ==========================================================================
  agent:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: cogent-agent
    depends_on:
      nats:
        condition: service_healthy
    environment:
      # Authentication (set via .env file or docker-compose override)
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GH_TOKEN=${GH_TOKEN:-}

      # NATS configuration
      - NATS_URL=nats://nats:4222

      # Agent configuration
      - AGENT_ID=${AGENT_ID:-cogent-agent-001}
      - WORKSPACE_DIR=/workspace
      - ASSETS_DIR=/assets
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Git configuration
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Cogent Agent}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-cogent@localhost}
      - GIT_COMMITTER_NAME=${GIT_AUTHOR_NAME:-Cogent Agent}
      - GIT_COMMITTER_EMAIL=${GIT_AUTHOR_EMAIL:-cogent@localhost}

      # Terminal/Rich output settings (disable fancy terminal features)
      - TERM=dumb
      - NO_COLOR=1
      - FORCE_COLOR=0
      - COLUMNS=120
      - PYTHONUNBUFFERED=1
      # Disable Claude Code terminal features
      - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
    volumes:
      # Working directories
      - ${WORKSPACE_PATH:-./workspace}:/workspace
      - ${ASSETS_PATH:-./assets}:/assets

      # Claude configuration persistence
      - claude_config:/home/cogent/.claude

      # Git credentials (optional - can mount SSH keys)
      - ${SSH_KEY_PATH:-/dev/null}:/home/cogent/.ssh/id_rsa:ro
    networks:
      - cogent-network
    # Disabled TTY to prevent terminal escape sequence noise
    # stdin_open: true
    # tty: true
    restart: unless-stopped

  # ==========================================================================
  # WebSocket Gateway (for web/mobile clients)
  # ==========================================================================
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: cogent-gateway
    depends_on:
      nats:
        condition: service_healthy
    ports:
      - "8080:8080"   # WebSocket port
    environment:
      - NATS_URL=nats://nats:4222
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8080
    networks:
      - cogent-network
    entrypoint: ["python", "-m", "src.communication.websocket_gateway"]
    profiles:
      - gateway  # Start with: docker-compose --profile gateway up
    restart: unless-stopped

  # ==========================================================================
  # CLI Client (for development/testing)
  # ==========================================================================
  cli:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: cogent-cli
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
      - AGENT_ID=${AGENT_ID:-cogent-agent-001}
    networks:
      - cogent-network
    entrypoint: ["python", "-m", "src.cli.main"]
    profiles:
      - cli  # Only start when explicitly requested
    stdin_open: true
    tty: true

# ==========================================================================
# Networks
# ==========================================================================
networks:
  cogent-network:
    driver: bridge
    name: cogent-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  nats_data:
    name: cogent-nats-data
  claude_config:
    name: cogent-claude-config
